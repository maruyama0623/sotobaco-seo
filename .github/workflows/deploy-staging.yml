name: Deploy to Staging

on:
  push:
    branches:
      - develop

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      blog: ${{ steps.filter.outputs.blog }}
      corporate: ${{ steps.filter.outputs.corporate }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Detect changed sites
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            blog:
              - 'sites/blog/**'
              - 'images/**'
              - 'packages/**'
            corporate:
              - 'sites/corporate/**'
              - 'images/**'
              - 'packages/**'

  deploy-blog:
    needs: detect-changes
    if: needs.detect-changes.outputs.blog == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: sites/blog/.nvmrc
          cache: npm
          cache-dependency-path: sites/blog/package-lock.json

      - name: Install dependencies
        working-directory: sites/blog
        run: npm ci

      - name: Link shared packages
        run: ln -s ../sites/blog/node_modules packages/node_modules

      - name: Build
        working-directory: sites/blog
        run: npm run build

      - name: Add robots.txt to block indexing
        run: |
          printf "User-agent: *\nDisallow: /\n" > sites/blog/out/robots.txt

      - name: Add Basic auth for staging
        env:
          STAGING_USER: ${{ secrets.STAGING_BASIC_AUTH_USER }}
          STAGING_PASS: ${{ secrets.STAGING_BASIC_AUTH_PASS }}
          HTPASSWD_DIR: ${{ secrets.STAGING_BLOG_PATH }}
        run: |
          HASHED=$(openssl passwd -apr1 "$STAGING_PASS")
          echo "${STAGING_USER}:${HASHED}" > sites/blog/out/.htpasswd
          AUTH_BLOCK="AuthType Basic
          AuthName \"Staging\"
          AuthUserFile ${HTPASSWD_DIR}/.htpasswd
          Require valid-user

          <Files \".htpasswd\">
            Require all denied
          </Files>
          "
          printf '%s\n\n' "$AUTH_BLOCK" | cat - sites/blog/out/.htaccess > /tmp/htaccess_new
          mv /tmp/htaccess_new sites/blog/out/.htaccess

      - name: Deploy to staging
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SFTP_HOST }}
          port: 8022
          username: ${{ secrets.SFTP_USERNAME }}
          key: ${{ secrets.SFTP_KEY }}
          source: "sites/blog/out/"
          target: ${{ secrets.STAGING_BLOG_PATH }}
          strip_components: 3
          overwrite: true

  deploy-corporate:
    needs: detect-changes
    if: needs.detect-changes.outputs.corporate == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: sites/corporate/.nvmrc
          cache: npm
          cache-dependency-path: sites/corporate/package-lock.json

      - name: Install dependencies
        working-directory: sites/corporate
        run: npm ci

      - name: Link shared packages
        run: ln -s ../sites/corporate/node_modules packages/node_modules

      - name: Build
        working-directory: sites/corporate
        run: npm run build
        env:
          NEXT_PUBLIC_BLOG_URL: https://stg.blog.sotobaco.com/

      - name: Add robots.txt to block indexing
        run: |
          printf "User-agent: *\nDisallow: /\n" > sites/corporate/out/robots.txt

      - name: Add Basic auth for staging
        env:
          STAGING_USER: ${{ secrets.STAGING_BASIC_AUTH_USER }}
          STAGING_PASS: ${{ secrets.STAGING_BASIC_AUTH_PASS }}
          HTPASSWD_DIR: ${{ secrets.STAGING_SITE_PATH }}
        run: |
          HASHED=$(openssl passwd -apr1 "$STAGING_PASS")
          echo "${STAGING_USER}:${HASHED}" > sites/corporate/out/.htpasswd
          AUTH_BLOCK="AuthType Basic
          AuthName \"Staging\"
          AuthUserFile ${HTPASSWD_DIR}/.htpasswd
          Require valid-user

          <Files \".htpasswd\">
            Require all denied
          </Files>
          "
          printf '%s\n\n' "$AUTH_BLOCK" | cat - sites/corporate/out/.htaccess > /tmp/htaccess_new
          mv /tmp/htaccess_new sites/corporate/out/.htaccess

      - name: Deploy to staging
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SFTP_HOST }}
          port: 8022
          username: ${{ secrets.SFTP_USERNAME }}
          key: ${{ secrets.SFTP_KEY }}
          source: "sites/corporate/out/"
          target: ${{ secrets.STAGING_SITE_PATH }}
          strip_components: 3
          overwrite: true

  sync-kintone:
    needs: [detect-changes, deploy-blog]
    if: needs.detect-changes.outputs.blog == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse article frontmatter and sync to kintone
        env:
          BLOG_API_URL: ${{ secrets.BLOG_API_URL }}
          BLOG_WEBHOOK_SECRET: ${{ secrets.BLOG_WEBHOOK_SECRET }}
        run: |
          # 記事のfrontmatterをパースしてJSON配列を生成
          ARTICLES="[]"
          for file in sites/blog/articles/*.md; do
            filename=$(basename "$file")
            # frontmatterをパース（---で囲まれた部分）
            title=$(sed -n 's/^title: *"\(.*\)"/\1/p' "$file")
            slug=$(sed -n 's/^slug: *"\(.*\)"/\1/p' "$file")
            description=$(sed -n 's/^description: *"\(.*\)"/\1/p' "$file")
            articleNumber=$(sed -n 's/^articleNumber: *\([0-9]*\)/\1/p' "$file")
            publishedAt=$(sed -n 's/^publishedAt: *"\(.*\)"/\1/p' "$file")

            if [ -n "$slug" ]; then
              ARTICLES=$(echo "$ARTICLES" | jq --arg t "$title" --arg s "$slug" \
                --arg d "$description" \
                --arg an "$articleNumber" --arg pa "$publishedAt" \
                --arg fn "$filename" \
                '. + [{"title":$t,"slug":$s,"description":$d,"articleNumber":($an|tonumber),"publishedAt":$pa,"filename":$fn}]')
            fi
          done

          BODY=$(echo "$ARTICLES" | jq -c '{articles: .}')
          TIMESTAMP=$(date +%s)
          SIGNATURE=$(printf '%s' "${TIMESTAMP}:${BODY}" | openssl dgst -sha256 -hmac "$BLOG_WEBHOOK_SECRET" | sed 's/^.* //')

          HTTP_CODE=$(curl -s -o /tmp/response.json -w "%{http_code}" -X POST "${BLOG_API_URL}/sync" \
            -H "Content-Type: application/json" \
            -H "X-Signature-Timestamp: ${TIMESTAMP}" \
            -H "X-Signature: ${SIGNATURE}" \
            -d "$BODY")

          echo "HTTP Status: $HTTP_CODE"
          cat /tmp/response.json
          echo ""

          if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
            echo "::error::Sync failed with HTTP $HTTP_CODE"
            exit 1
          fi
